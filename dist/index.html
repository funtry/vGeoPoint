<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>长江大学DFS数据库共享平台</title>
    <link rel="stylesheet" href="//a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
    <script src="//webapi.amap.com/maps?v=2.0&key=ea9271dcc696f932fdd4b36b1de67c5c&&plugin=AMap.GeoJSON"></script>
    <script src="https://a.amap.com/jsapi_demos/static/demo-center/js/demoutils.js"></script>
    <style>
        html,
        body {
            height: 100%;
        }

        #container {
            height: 100%;
            position: relative;
        }

        .context_menu {
            position: relative;
            min-width: 12rem;
            padding: 0;
        }

        .context_menu p {
            cursor: pointer;
            padding: 0.25rem 1.25rem;
        }

        .context_menu p:hover {
            background: #ddd;
        }

        .amap-icon img,
        .amap-marker-content img {
            width: 16px;
            height: 16px;
        }

        .input-card {
            width: 20px;
            top: 10px;
            left: 10px;
            bottom: auto;
        }
    </style>
</head>

<body>
    <div id="container"></div>
    <div class="info" id="text" align="right">
        鼠标滑过对象查询信息
    </div>
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "ea9271dcc696f932fdd4b36b1de67c5c",
        };
        window.onLoad = function () {
            var lnglat = new AMap.LngLat(-58, -28);
            var map = new AMap.Map('container', {
                center: lnglat,
                layers: [new AMap.TileLayer.Satellite()],
                zoom: 4
            });

            var wms = new AMap.TileLayer.WMTS({
                url: 'https://services.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer/WMTS',
                blend: true,
                tileSize: 256,
                params: {
                    VERSION: '1.1.0'
                }
            });

            wms.setMap(map);
            wms.hide();

            var contextMenu = new AMap.ContextMenu();
            contextMenu.addItem("高清影像", function () {
                wms.show();
                contextMenu.close();
            }, 0);
            contextMenu.addItem("普通影像", function () {
                wms.hide();
                contextMenu.close();
            }, 1);

            map.on('rightclick', function (e) {
                contextMenu.open(map, e.lnglat);
                contextMenuPositon = e.lnglat;
            });
            contextMenu.open(map, lnglat);
            map.plugin([
                'AMap.ToolBar',
                'AMap.Scale',
                'AMap.HawkEye',
                'AMap.MapType',
                'AMap.GeoJSON',
            ], function () {
                var view = new AMap.HawkEye({
                    visible: true,
                    isOpen: true,
                    showLabel: true,
                    //mapStyle: 'amap://styles/dark',
                    width: '240px',
                    height: '120px',
                });
                map.addControl(view);
                map.addControl(new AMap.Scale());

                var basin;
                var apex;
                var sediment;
                ajax('./src/static/json/basin.geojson', function (err, geoJSON) {
                    if (!err) {
                        basin = new AMap.GeoJSON({
                            geoJSON: geoJSON,
                            // 还可以自定义getMarker和getPolyline
                            getPolygon: function (geojson, lnglats) {
                                var area = AMap.GeometryUtil.ringArea(lnglats[0]);
                                return new AMap.Polygon({
                                    path: lnglats,
                                    fillOpacity: 0.5,
                                    strokeWeight: 1,
                                    strokeColor: '#800080',
                                    fillColor: 'none',
                                }).on("mouseover", () => {
                                    document.querySelector("#text").innerText = 'DFS源区面积 =' + (area/1000000).toFixed(2) + ' 平方千米';
                                }).on("mouseout", () => {
                                    document.querySelector("#text").innerText = '鼠标滑过对象查询信息';
                                });
                            }
                        });
                        map.add(basin);
                        log.success('源区加载完成')
                    } else {
                        log.error('加载源区服务请求失败')
                    }
                })
                ajax('./src/static/json/apex.geojson', function (err, geoJSON) {
                    if (!err) {
                        apex = new AMap.GeoJSON({
                            geoJSON: geoJSON,
                            // 还可以自定义getMarker和getPolyline
                            getMarker: function (geojson, lnglats) {
                                var x = lnglats[0].toFixed(2);
                                var y = lnglats[1].toFixed(2);
                                return new AMap.Marker({
                                    position: lnglats,
                                    icon: './src/static/img/star48.png',
                                    offset: new AMap.Pixel(-8, -8),
                                    title: 'Code =' + geojson.properties.Code,
                                }).on("mouseover", (e) => {
                                    document.querySelector("#text").innerText = 'DFS顶点位置：(' + x + ', ' + y +')';
                                }).on("mouseout", () => {
                                    document.querySelector("#text").innerText = '鼠标滑过对象查询信息';
                                });
                            }
                        });
                        map.add(apex);
                        log.success('顶点数据加载完成')
                    } else {
                        log.error('加载顶点服务请求失败')
                    }
                })
                ajax('./src/static/json/sediment.geojson', function (err, geoJSON) {
                    if (!err) {
                        sediment = new AMap.GeoJSON({
                            geoJSON: geoJSON,
                            // 还可以自定义getMarker和getPolyline
                            getPolygon: function (geojson, lnglats) {
                                var area = AMap.GeometryUtil.ringArea(lnglats[0]);
                                return new AMap.Polygon({
                                    path: lnglats,
                                    fillOpacity: 0.5,
                                    strokeWeight: 1,
                                    strokeColor: 'red',
                                    fillColor: 'none'
                                }).on("mouseover", () => {
                                    document.querySelector("#text").innerText = 'DFS沉积区面积 =' + (area/1000000).toFixed(2) + ' 平方千米';
                                }).on("mouseout", () => {
                                    document.querySelector("#text").innerText = '鼠标滑过对象查询信息';
                                });
                            }
                        });
                        map.add(sediment);
                        log.success('沉积区数据加载完成')
                    } else {
                        log.error('加载沉积区服务请求失败')
                    }
                })
                map.setFitView();
            });
        }
        var url = 'https://webapi.amap.com/maps?v=2.0&key=b54f945a4c9a9300e0574da4fc67e445&callback=onLoad';
        var jsapi = document.createElement('script');
        jsapi.charset = 'utf-8';
        jsapi.src = url;
        document.head.appendChild(jsapi);
    </script>

</body>

</html>